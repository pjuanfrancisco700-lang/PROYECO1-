<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Nave de Cuaderno</title>

  <!-- Bloquear zoom en m√≥vil -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      overscroll-behavior-x: none;
      background:
        repeating-linear-gradient(
          to bottom,
          #fdfbf6,
          #fdfbf6 22px,
          #d7e3ff 23px
        );
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    input, button, select {
      font-size: 16px !important;
      touch-action: manipulation;
    }

    .app {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card {
      background: rgba(255, 255, 255, 0.9);
      border: 1.5px solid #444;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 0 0 1px #00000020;
    }

    .title {
      text-align: center;
      font-family: "Comic Sans MS", system-ui;
      margin: 0 0 4px;
      font-size: 1.4rem;
    }

    .subtitle {
      text-align: center;
      font-size: 0.8rem;
      opacity: 0.7;
      margin-bottom: 6px;
    }

    label {
      font-size: 0.8rem;
      display: block;
      margin-top: 4px;
    }

    input[type="text"], select {
      width: 100%;
      padding: 7px;
      border-radius: 6px;
      border: 1px solid #888;
      margin-top: 2px;
      background: #fff;
    }

    .row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }

    button {
      background: #fff;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1.5px solid #222;
      font-weight: 600;
      flex: 1;
      cursor: pointer;
      box-shadow: 1px 1px 0 #00000060;
    }

    button:active {
      transform: translate(1px,1px);
      box-shadow: 0 0 0 #000;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      margin-top: 4px;
    }

    .game-wrapper {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #gameCanvas {
      width: 100%;
      height: auto;
      background: #ffffff;
      border: 1.5px solid #333;
      border-radius: 12px;
      touch-action: none;
      box-shadow: 2px 2px 0 #00000040;
    }

    .controls {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }

    .ranking {
      max-height: 150px;
      overflow-y: auto;
      font-size: 0.85rem;
      margin-top: 4px;
    }

    .ranking-item {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      border-bottom: 1px dashed #ccc;
    }

    .game-over-banner {
      position: absolute;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
    }

    .game-over-text {
      background: #fff8e1;
      border: 2px solid #222;
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 1rem;
      box-shadow: 2px 2px 0 #00000070;
      white-space: pre-line;
      text-align: center;
    }
  </style>
</head>

<body>
<div class="app">

  <!-- Panel superior -->
  <div class="card">
    <h1 class="title">Nave de Cuaderno</h1>
    <div class="subtitle">Dispara a los c√≠rculos. Evita que te golpeen.</div>

    <label for="playerName">Tu nombre:</label>
    <input id="playerName" type="text" placeholder="Ej. Sergio" />

    <label for="shipSkin">Skin de nave (lapicero):</label>
    <select id="shipSkin">
      <option value="1">Nave 1 - Tri√°ngulo</option>
      <option value="2">Nave 2 - Cohete</option>
      <option value="3">Nave 3 - Platillo</option>
    </select>

    <div class="row">
      <button id="btnUseName">Usar nombre</button>
      <button id="btnShowRanking">Ver ranking</button>
    </div>

    <div class="status-bar">
      <div><b>Jugador:</b> <span id="currentPlayer">‚Äî</span></div>
      <div><b>Mejor:</b> <span id="bestScore">0</span></div>
    </div>
  </div>

  <!-- Juego -->
  <div class="game-wrapper card">
    <canvas id="gameCanvas"></canvas>

    <div class="status-bar">
      <div><b>Puntaje:</b> <span id="score">0</span></div>
      <div><b>Nivel:</b> <span id="levelLabel">1</span></div>
      <div><b>Estado:</b> <span id="gameStateText">Listo</span></div>
    </div>

    <div class="controls">
      <button id="btnLeft">‚¨ÖÔ∏è</button>
      <button id="btnShoot">üî´ / Start</button>
      <button id="btnRight">‚û°Ô∏è</button>
    </div>

    <div class="game-over-banner" id="gameOverBanner" style="display:none;">
      <div class="game-over-text" id="gameOverText">Game Over</div>
    </div>
  </div>

  <!-- Ranking -->
  <div class="card">
    <b>Ranking (este dispositivo)</b>
    <div id="rankingList" class="ranking"></div>
  </div>

</div>

<script>
/* ====================== RANKING LOCAL ====================== */
const STORAGE_KEY = "naveCuadernoRanking_v2";

function loadRanking() {
  const raw = localStorage.getItem(STORAGE_KEY);
  return raw ? JSON.parse(raw) : [];
}
function saveRanking(r) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(r));
}
function addScore(name, score) {
  const r = loadRanking();
  r.push({ name, score, date: Date.now() });
  r.sort((a, b) => b.score - a.score);
  saveRanking(r.slice(0, 20));
}
function bestFor(name) {
  const r = loadRanking().filter(x => x.name === name);
  return r.length ? Math.max(...r.map(x => x.score)) : 0;
}
function renderRanking() {
  const container = document.getElementById("rankingList");
  const r = loadRanking();
  container.innerHTML = "";
  if (!r.length) {
    container.textContent = "Sin puntajes a√∫n. Juega una partida.";
    return;
  }
  r.forEach((item, i) => {
    const row = document.createElement("div");
    row.className = "ranking-item";
    row.innerHTML = `<span>${i + 1}. ${item.name}</span><span>${item.score}</span>`;
    container.appendChild(row);
  });
}

/* ====================== SONIDOS (Web Audio) ====================== */
let audioCtx = null;
function getAudioCtx() {
  if (!audioCtx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
  }
  if (audioCtx.state === "suspended") audioCtx.resume();
  return audioCtx;
}
function beep(type) {
  try {
    const ctx = getAudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);

    if (type === "shoot") {
      osc.frequency.value = 520;
      gain.gain.setValueAtTime(0.12, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.12);
    } else if (type === "hit") {
      osc.frequency.value = 720;
      gain.gain.setValueAtTime(0.16, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
    } else if (type === "gameover") {
      osc.frequency.setValueAtTime(260, ctx.currentTime);
      osc.frequency.linearRampToValueAtTime(90, ctx.currentTime + 0.4);
      gain.gain.setValueAtTime(0.2, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.4);
    }

    osc.start();
    osc.stop(ctx.currentTime + 0.45);
  } catch (e) {
    // iOS a veces bloquea audio antes de interacci√≥n: ignorar errores silenciosamente
  }
}

/* ====================== JUEGO ====================== */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let ship = {
  x: 0,
  y: 0,
  w: 42,
  h: 22
};
let bullets = [];
let circles = [];
let score = 0;
let running = false;
let gameOver = false;
let lastSpawnTime = 0;
let level = 1;
let currentPlayer = "";
let lastFrameTime = 0;

function resizeCanvas() {
  const width = canvas.clientWidth || canvas.parentElement.clientWidth || 300;
  const height = Math.min(window.innerHeight * 0.45, 420);
  canvas.width = width;
  canvas.height = height;
  ship.x = width / 2;
  ship.y = height - 40;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

function getLevel() {
  // Cada 10 puntos sube el nivel
  return Math.floor(score / 10) + 1;
}
function circleSpeed() {
  return 1.5 + (level - 1) * 0.4;
}
function spawnIntervalMs() {
  const base = 900;      // 0: f√°cil
  const min = 350;
  const interval = base - (level - 1) * 80;
  return Math.max(min, interval);
}

function spawnCircle() {
  const x = 16 + Math.random() * (canvas.width - 32);
  circles.push({
    x,
    y: -20,
    r: 10 + Math.random() * 8,
    speed: circleSpeed()
  });
}

function shoot() {
  if (!running || gameOver) {
    resetGame();
    return;
  }
  bullets.push({
    x: ship.x,
    y: ship.y - ship.h / 2,
    speed: 5
  });
  beep("shoot");
}

function resetGame() {
  bullets = [];
  circles = [];
  score = 0;
  level = 1;
  running = true;
  gameOver = false;
  lastSpawnTime = performance.now();
  lastFrameTime = performance.now();
  document.getElementById("score").textContent = score;
  document.getElementById("levelLabel").textContent = level;
  document.getElementById("gameStateText").textContent = "Jugando";
  document.getElementById("gameOverBanner").style.display = "none";
  requestAnimationFrame(loop);
}

function endGame() {
  if (gameOver) return;
  running = false;
  gameOver = true;
  document.getElementById("gameStateText").textContent = "Terminado";

  const text = `Te golpe√≥ un c√≠rculo üòµ\nPuntaje: ${score}\nNivel: ${level}`;
  document.getElementById("gameOverText").textContent = text;
  document.getElementById("gameOverBanner").style.display = "flex";
  beep("gameover");

  if (currentPlayer) {
    addScore(currentPlayer, score);
    renderRanking();
    document.getElementById("bestScore").textContent = bestFor(currentPlayer);
  }
}

function update(dt, now) {
  // Subir nivel si corresponde
  const newLevel = getLevel();
  if (newLevel !== level) {
    level = newLevel;
    document.getElementById("levelLabel").textContent = level;
  }

  // Spawn de c√≠rculos
  if (now - lastSpawnTime > spawnIntervalMs()) {
    lastSpawnTime = now;
    spawnCircle();
  }

  // Mover balas
  bullets.forEach(b => {
    b.y -= b.speed * dt;
  });
  bullets = bullets.filter(b => b.y > -10);

  // Actualizar velocidad de c√≠rculos (depende del nivel)
  circles.forEach(c => {
    c.y += circleSpeed() * dt;
  });
  circles = circles.filter(c => c.y < canvas.height + 40);

  // Colisi√≥n balas-c√≠rculos
  bullets.forEach(b => {
    circles.forEach(c => {
      if (c._hit) return;
      const dx = b.x - c.x;
      const dy = b.y - c.y;
      if (Math.sqrt(dx * dx + dy * dy) <= c.r + 4) {
        c._hit = true;
        b._hit = true;
        score++;
        document.getElementById("score").textContent = score;
        beep("hit");
      }
    });
  });
  bullets = bullets.filter(b => !b._hit);
  circles = circles.filter(c => !c._hit);

  // Colisi√≥n c√≠rculos-nave (game over)
  circles.forEach(c => {
    const dx = Math.abs(c.x - ship.x);
    const dy = Math.abs(c.y - ship.y);
    const collisionX = dx < ship.w * 0.6;
    const collisionY = dy < ship.h * 0.8;
    if (collisionX && collisionY) {
      endGame();
    }
  });
}

function drawShip() {
  const skin = document.getElementById("shipSkin").value;
  const x = ship.x;
  const y = ship.y;
  const w = ship.w;
  const h = ship.h;

  ctx.save();
  ctx.translate(x, y);
  ctx.strokeStyle = "#222";
  ctx.lineWidth = 1.6;
  ctx.lineJoin = "round";

  if (skin === "1") {
    // Tri√°ngulo simple
    ctx.beginPath();
    ctx.moveTo(-w / 2, h / 2);
    ctx.lineTo(0, -h / 2);
    ctx.lineTo(w / 2, h / 2);
    ctx.closePath();
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(0, 0, 3.5, 0, Math.PI * 2);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(-w / 4, h / 2);
    ctx.lineTo(-w / 6, h / 2 + 6);
    ctx.moveTo(w / 4, h / 2);
    ctx.lineTo(w / 6, h / 2 + 6);
    ctx.stroke();
  } else if (skin === "2") {
    // Cohete l√°piz
    ctx.beginPath();
    ctx.moveTo(0, -h / 2 - 4);
    ctx.lineTo(-w / 4, -h / 6);
    ctx.lineTo(-w / 4, h / 3);
    ctx.lineTo(w / 4, h / 3);
    ctx.lineTo(w / 4, -h / 6);
    ctx.closePath();
    ctx.stroke();

    // ventanita
    ctx.beginPath();
    ctx.arc(0, -h / 8, 3, 0, Math.PI * 2);
    ctx.stroke();

    // aletas
    ctx.beginPath();
    ctx.moveTo(-w / 4, h / 3);
    ctx.lineTo(-w / 2.5, h / 2 + 3);
    ctx.moveTo(w / 4, h / 3);
    ctx.lineTo(w / 2.5, h / 2 + 3);
    ctx.stroke();

    // fuego
    ctx.beginPath();
    ctx.moveTo(-w / 8, h / 3);
    ctx.lineTo(0, h / 2 + 6);
    ctx.lineTo(w / 8, h / 3);
    ctx.stroke();
  } else {
    // Platillo
    ctx.beginPath();
    ctx.ellipse(0, 0, w / 2, h / 2, 0, 0, Math.PI * 2);
    ctx.stroke();

    ctx.beginPath();
    ctx.ellipse(0, -h / 4, w / 3, h / 3, 0, 0, Math.PI * 2);
    ctx.stroke();

    // patitas
    ctx.beginPath();
    ctx.moveTo(-w / 4, h / 2);
    ctx.lineTo(-w / 4, h / 2 + 6);
    ctx.moveTo(w / 4, h / 2);
    ctx.lineTo(w / 4, h / 2 + 6);
    ctx.stroke();
  }

  ctx.restore();
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // c√≠rculos
  ctx.strokeStyle = "#222";
  ctx.lineWidth = 1.4;
  circles.forEach(c => {
    ctx.beginPath();
    ctx.arc(c.x, c.y, c.r, 0, Math.PI * 2);
    ctx.stroke();
  });

  // balas
  bullets.forEach(b => {
    ctx.beginPath();
    ctx.moveTo(b.x, b.y);
    ctx.lineTo(b.x, b.y + 6);
    ctx.stroke();
  });

  // nave
  drawShip();
}

function loop(timestamp) {
  if (!running) return;
  if (!lastFrameTime) lastFrameTime = timestamp;
  const dtMs = timestamp - lastFrameTime;
  lastFrameTime = timestamp;
  const dt = dtMs / 16.67; // normalizado ~60fps

  update(dt, timestamp);
  draw();
  requestAnimationFrame(loop);
}

/* ====================== CONTROLES ====================== */
document.getElementById("btnLeft").addEventListener("click", () => {
  ship.x -= 20;
});
document.getElementById("btnRight").addEventListener("click", () => {
  ship.x += 20;
});
document.getElementById("btnShoot").addEventListener("click", shoot);

// arrastrar dedo para mover nave
let dragging = false;
canvas.addEventListener("pointerdown", e => {
  dragging = true;
  getAudioCtx(); // desbloquear audio con primera interacci√≥n
});
canvas.addEventListener("pointerup", () => (dragging = false));
canvas.addEventListener("pointercancel", () => (dragging = false));
canvas.addEventListener("pointermove", e => {
  if (!dragging) return;
  const rect = canvas.getBoundingClientRect();
  ship.x = e.clientX - rect.left;
});

// tap en zona baja del canvas dispara
canvas.addEventListener("click", e => {
  const rect = canvas.getBoundingClientRect();
  const y = e.clientY - rect.top;
  if (y > rect.height * 0.6) {
    shoot();
  }
});

/* ====================== NOMBRE & RANKING ====================== */
const nameInput = document.getElementById("playerName");
const currentPlayerLabel = document.getElementById("currentPlayer");
const bestScoreLabel = document.getElementById("bestScore");

document.getElementById("btnUseName").addEventListener("click", () => {
  const name = nameInput.value.trim();
  if (!name) {
    alert("Escribe un nombre para guardar tus puntajes.");
    return;
  }
  currentPlayer = name;
  currentPlayerLabel.textContent = name;
  bestScoreLabel.textContent = bestFor(name);
});

document.getElementById("btnShowRanking").addEventListener("click", () => {
  renderRanking();
});

// Inicial
renderRanking();
document.getElementById("levelLabel").textContent = level;
</script>
</body>
</html>
