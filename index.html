<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>MiniApp Ventas ‚Äî DEMO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <style>
    :root {
      --bg: #f2f2f7;
      --card: #ffffff;
      --accent: #2c6e7f;
      --accent-soft: #e3f0f4;
      --text-main: #111111;
      --text-muted: #666666;
      --danger: #c0392b;
      --success: #1e8449;
      --border-soft: #e0e0e5;
      --shadow-soft: 0 8px 20px rgba(0, 0, 0, 0.06);
      --radius-lg: 18px;
      --radius-xl: 22px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin:0;
      font-family:system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", Arial, sans-serif;
      background:var(--bg);
      color:var(--text-main);
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    .app-shell {
      max-width:480px;
      margin:0 auto;
      width:100%;
      height:100vh;
      display:flex;
      flex-direction:column;
      padding:10px 10px 0;
    }

    header { padding:8px 6px 4px; }
    header h1 { font-size:1.1rem; margin:0; font-weight:700; }
    header p { margin:2px 0 0; font-size:0.75rem; color:var(--text-muted); }

    main {
      flex:1;
      overflow-y:auto;
      padding:6px 0 12px;
    }

    .view { display:none; animation:fadeIn 0.22s ease-out; }
    .view.active { display:block; }

    @keyframes fadeIn {
      from{opacity:0; transform:translateY(4px);} to{opacity:1; transform:translateY(0);}
    }

    .card {
      background:var(--card);
      border-radius:var(--radius-xl);
      box-shadow:var(--shadow-soft);
      padding:14px 16px;
      margin-bottom:12px;
      border:1px solid rgba(0,0,0,0.02);
    }

    .card-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }

    .card-title { font-size:0.9rem; font-weight:600; }

    .pill {
      font-size:0.7rem;
      padding:3px 8px;
      border-radius:999px;
      background:var(--accent-soft);
      color:var(--accent);
      font-weight:500;
    }

    .metrics {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
      margin-top:6px;
    }

    .metric-item {
      padding:8px 10px;
      border-radius:var(--radius-lg);
      background:#f8f8fb;
      border:1px solid var(--border-soft);
    }

    .metric-label { font-size:0.65rem; color:var(--text-muted); margin-bottom:2px; }
    .metric-value { font-size:0.9rem; font-weight:600; }
    .metric-sub { font-size:0.65rem; color:var(--text-muted); }

    .list { margin:0; padding:0; list-style:none; }

    .list-item {
      padding:8px 0;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      border-bottom:1px dashed #ececf2;
      gap:8px;
    }

    .list-title { font-size:0.8rem; font-weight:500; }
    .list-meta { font-size:0.7rem; color:var(--text-muted); }

    .badge {
      font-size:0.68rem;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid var(--border-soft);
      white-space:nowrap;
    }

    .badge-pending { color:var(--danger); border-color:var(--danger); }
    .badge-sent { color:var(--success); border-color:var(--success); }

    .form-group { margin-bottom:10px; }
    .form-group label { display:block; font-size:0.75rem; margin-bottom:4px; color:var(--text-muted); }
    .form-group input, .form-group select {
      width:100%;
      border-radius:14px;
      border:1px solid var(--border-soft);
      padding:9px 11px;
      font-size:0.85rem;
      background:#fbfbff;
    }

    .btn {
      border:none;
      border-radius:16px;
      padding:9px 13px;
      font-size:0.85rem;
      font-weight:600;
      cursor:pointer;
    }

    .btn-primary { background:var(--accent); color:#fff; }
    .btn-secondary { background:#f2f2f7; border:1px solid var(--border-soft); }

    .btn-sm {
      padding:6px 10px;
      font-size:0.75rem;
      border-radius:999px;
    }

    .tab-bar {
      display:flex;
      justify-content:space-around;
      border-top:1px solid #ddd;
      padding:6px 8px;
      background:#f2f2f7;
      position:sticky;
      bottom:0;
    }

    .tab-item {
      flex:1;
      text-align:center;
      font-size:0.7rem;
      padding:4px 0;
      cursor:pointer;
    }

    .tab-item.active {
      background:#fff;
      color:var(--accent);
      font-weight:600;
      border-radius:10px;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <h1>MiniApp Ventas ‚Äî DEMO</h1>
      <p>Prueba de Sync URL + Token</p>
    </header>

    <main>
      <!-- DASHBOARD -->
      <section id="view-dashboard" class="view active">
        <div class="card">
          <div class="card-header">
            <span class="card-title">Resumen</span>
            <span class="pill">Demo</span>
          </div>
          <div class="metrics">
            <div class="metric-item">
              <div class="metric-label">Ventas</div>
              <div class="metric-value" id="metric-ventas-count">0</div>
              <div class="metric-sub">en este dispositivo</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">Total Q</div>
              <div class="metric-value" id="metric-ventas-total">0.00</div>
              <div class="metric-sub">bruto local</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">Pendientes</div>
              <div class="metric-value" id="metric-pendientes">0</div>
              <div class="metric-sub">sin sincronizar</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">√öltimas ventas</div>
            <button class="btn btn-secondary btn-sm" onclick="setActiveView('ventas')">+ Nueva</button>
          </div>
          <ul id="lista-ultimas-ventas" class="list"></ul>
        </div>
      </section>

      <!-- VENTAS -->
      <section id="view-ventas" class="view">
        <div class="card">
          <div class="card-header"><span class="card-title">Registrar venta</span></div>
          <div class="form-group"><label>Cliente</label><input id="input-cliente"></div>
          <div class="form-group"><label>Monto Q</label><input id="input-monto" type="number"></div>
          <div class="form-group">
            <label>M√©todo</label>
            <select id="select-metodo">
              <option>Contado</option>
              <option>Cr√©dito</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="registrarVenta()">Guardar</button>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">Historial</span></div>
          <ul class="list" id="lista-ventas-completa"></ul>
        </div>
      </section>

      <!-- CONFIG -->
      <section id="view-config" class="view">
        <div class="card">
          <div class="card-header"><span class="card-title">Sincronizaci√≥n</span></div>
          <div class="form-group">
            <label>Sync URL</label>
            <input id="input-sync-url" placeholder="https://script.google.com/macros/s/.../exec">
          </div>
          <div class="form-group">
            <label>Token</label>
            <input id="input-token" placeholder="TOKEN_MINIAPP_2025">
          </div>
          <div class="form-group">
            <button class="btn btn-primary" onclick="guardarConfig()">Guardar</button>
          </div>
          <div class="form-group">
            <button class="btn btn-secondary" onclick="probarConexion()">Probar conexi√≥n</button>
          </div>
          <div class="form-group">
            <button class="btn btn-primary" onclick="sincronizarPendientes()">Sincronizar pendientes</button>
          </div>
        </div>
      </section>
    </main>

    <nav class="tab-bar">
      <div class="tab-item active" data-target="dashboard">üìä<br>Inicio</div>
      <div class="tab-item" data-target="ventas">üßæ<br>Ventas</div>
      <div class="tab-item" data-target="config">‚öôÔ∏è<br>Config</div>
    </nav>
  </div>

  <script>
    // Claves de localStorage
    const KEY_VENTAS = "miniapp_demo_ventas";
    const KEY_SYNC_URL = "miniapp_demo_sync_url";
    const KEY_SYNC_TOKEN = "miniapp_demo_sync_token";

    let ventas = [];

    function loadFromLocalStorage() {
      try {
        const raw = localStorage.getItem(KEY_VENTAS);
        ventas = raw ? JSON.parse(raw) : [];
      } catch (e) {
        ventas = [];
      }

      document.getElementById("input-sync-url").value = localStorage.getItem(KEY_SYNC_URL) || "";
      document.getElementById("input-token").value = localStorage.getItem(KEY_SYNC_TOKEN) || "";
      renderDashboard();
      renderVentas();
    }

    function saveVentas() {
      localStorage.setItem(KEY_VENTAS, JSON.stringify(ventas));
      renderDashboard();
      renderVentas();
    }

    function formatCurrency(q) {
      const n = Number(q) || 0;
      return n.toLocaleString("es-GT", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatDateTime(iso) {
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleString("es-GT", {
        year: "2-digit",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function renderDashboard() {
      const count = ventas.length;
      const total = ventas.reduce((acc, v) => acc + (Number(v.monto) || 0), 0);
      const pendientes = ventas.filter(v => !v.enviado).length;

      document.getElementById("metric-ventas-count").textContent = count;
      document.getElementById("metric-ventas-total").textContent = formatCurrency(total);
      document.getElementById("metric-pendientes").textContent = pendientes;

      const listaUltimas = document.getElementById("lista-ultimas-ventas");
      listaUltimas.innerHTML = "";

      const ultimas = [...ventas].slice(-3).reverse();
      ultimas.forEach(v => {
        const li = document.createElement("li");
        li.className = "list-item";
        li.innerHTML = `<div class="list-main">
            <div class="list-title">${v.cliente}</div>
            <div class="list-meta">${formatDateTime(v.fecha)} ¬∑ Q${formatCurrency(v.monto)} ¬∑ ${v.metodo}</div>
          </div>
          <div class="badge ${v.enviado ? "badge-sent" : "badge-pending"}">${v.enviado ? "Enviado" : "Pendiente"}</div>`;
        listaUltimas.appendChild(li);
      });
    }

    function renderVentas() {
      const lista = document.getElementById("lista-ventas-completa");
      lista.innerHTML = "";

      [...ventas].reverse().forEach(v => {
        const li = document.createElement("li");
        li.className = "list-item";
        li.innerHTML = `<div class="list-main">
            <div class="list-title">${v.cliente} ¬∑ Q${formatCurrency(v.monto)}</div>
            <div class="list-meta">${formatDateTime(v.fecha)} ¬∑ ${v.metodo}</div>
          </div>
          <div class="badge ${v.enviado ? "badge-sent" : "badge-pending"}">${v.enviado ? "Enviado" : "Pendiente"}</div>`;
        lista.appendChild(li);
      });
    }

    async function registrarVenta() {
      const cliente = document.getElementById("input-cliente").value.trim() || "Sin cliente";
      const montoRaw = document.getElementById("input-monto").value.trim();
      const metodo = document.getElementById("select-metodo").value;
      const monto = Number(montoRaw);

      if (!montoRaw || isNaN(monto) || monto <= 0) {
        alert("Ingresa un monto v√°lido");
        return;
      }

      const venta = {
        id: Date.now().toString(),
        fecha: new Date().toISOString(),
        cliente,
        monto,
        metodo,
        enviado: false
      };

      ventas.push(venta);
      document.getElementById("input-monto").value = "";
      saveVentas();

      // intentar enviar de inmediato al servidor
      enviarVentaAlServidor(venta).then(ok => {
        if (ok) {
          const idx = ventas.findIndex(v => v.id === venta.id);
          if (idx !== -1) {
            ventas[idx].enviado = true;
            saveVentas();
          }
        }
      });
    }

    function guardarConfig() {
      const url = document.getElementById("input-sync-url").value.trim();
      const token = document.getElementById("input-token").value.trim();
      localStorage.setItem(KEY_SYNC_URL, url);
      localStorage.setItem(KEY_SYNC_TOKEN, token);
      alert("Configuraci√≥n guardada");
    }

    function getSyncConfig() {
      return {
        url: (localStorage.getItem(KEY_SYNC_URL) || "").trim(),
        token: (localStorage.getItem(KEY_SYNC_TOKEN) || "").trim()
      };
    }

    async function probarConexion() {
      const { url, token } = getSyncConfig();
      if (!url || !token) {
        alert("Primero configura Sync URL y Token.");
        return;
      }
      try {
        const resp = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, action: "ping" })
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        await resp.json().catch(() => null);
        alert("Conexi√≥n OK con Apps Script.");
      } catch (e) {
        alert("Error al conectar: " + e.message);
      }
    }

    async function enviarVentaAlServidor(venta) {
      const { url, token } = getSyncConfig();
      if (!url || !token) return false;
      try {
        const resp = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            token,
            action: "addVenta",
            data: venta
          })
        });
        if (!resp.ok) return false;
        const data = await resp.json().catch(() => null);
        if (data && data.ok === false) return false;
        return true;
      } catch (e) {
        console.error("Error enviando venta:", e);
        return false;
      }
    }

    async function sincronizarPendientes() {
      const pendientes = ventas.filter(v => !v.enviado);
      if (pendientes.length === 0) {
        alert("No hay ventas pendientes por enviar.");
        return;
      }
      let enviadas = 0;
      for (const v of pendientes) {
        const ok = await enviarVentaAlServidor(v);
        if (ok) {
          v.enviado = true;
          enviadas++;
        }
      }
      saveVentas();
      alert(`Sincronizaci√≥n terminada. Enviadas: ${enviadas} de ${pendientes.length}`);
    }

    // Maneja el cambio de vistas (tabs)
    function setActiveView(view) {
      // Oculta todas las vistas
      document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
      // Muestra la vista seleccionada
      const target = document.getElementById("view-" + view);
      if (target) target.classList.add("active");

      // Actualiza estado visual de las pesta√±as
      document.querySelectorAll(".tab-item").forEach(tab => {
        tab.classList.toggle("active", tab.dataset.target === view);
      });
    }

    // Inicializaci√≥n
    document.addEventListener("DOMContentLoaded", () => {
      // Click en tabs inferiores
      document.querySelectorAll(".tab-item").forEach(tab => {
        tab.addEventListener("click", () => setActiveView(tab.dataset.target));
      });

      // Cargar datos iniciales
      loadFromLocalStorage();
    });
  </script>
</body>
</html>
