<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Term√≥metro de Ventas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #111827;
      --card: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #f97373;
      --border: #1f2937;
      --radius-xl: 18px;
      --radius-2xl: 24px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .app-shell {
      width: 100%;
      max-width: 480px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 32px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow:
        0 32px 80px rgba(0, 0, 0, 0.75),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      padding: 14px 14px 10px 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      backdrop-filter: blur(24px);
    }

    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-soft);
      opacity: 0.9;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 2px 2px;
    }

    .app-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-icon {
      width: 26px;
      height: 26px;
      border-radius: 9px;
      background: conic-gradient(
        from 220deg,
        #38bdf8,
        #22c55e,
        #eab308,
        #f97316,
        #38bdf8
      );
      padding: 2px;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.6);
    }

    .app-icon-inner {
      width: 100%;
      height: 100%;
      border-radius: 7px;
      background: radial-gradient(circle at 20% 0, #f97316 0, #0f172a 45%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 700;
      color: #e5e7eb;
    }

    .app-name-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .app-name {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .app-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .pill {
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    .tab-bar {
      margin-top: 4px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      background: rgba(15, 23, 42, 0.8);
      border-radius: 999px;
      padding: 3px;
      border: 1px solid rgba(30, 64, 175, 0.4);
    }

    .tab-btn {
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-soft);
      font-size: 11px;
      padding: 6px 4px;
      border-radius: 999px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      cursor: pointer;
      transition: 0.18s all ease;
      font-weight: 500;
    }

    .tab-btn span.icon {
      font-size: 15px;
    }

    .tab-btn.active {
      background: radial-gradient(circle at top, #1d4ed8 0, #0f172a 55%);
      color: #f9fafb;
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.5),
        0 10px 18px rgba(15, 23, 42, 0.9);
    }

    .tab-btn .label {
      font-size: 10px;
    }

    .content {
      margin-top: 4px;
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card {
      background: radial-gradient(circle at top, #020617 0, #020617 60%);
      border-radius: var(--radius-2xl);
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 12px 12px 10px;
      box-shadow:
        0 18px 30px rgba(0, 0, 0, 0.85),
        0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    .badge {
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .config-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 11px;
      color: var(--text-soft);
    }

    .field input {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 7px 9px;
      font-size: 12px;
      color: var(--text);
      outline: none;
      width: 100%;
    }

    .field input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
    }

    .hint {
      font-size: 10px;
      color: var(--text-soft);
      margin-top: 6px;
    }

    .config-footer {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .ghost-btn {
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      padding: 6px 10px;
      font-size: 11px;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .ghost-btn span.icon {
      font-size: 13px;
    }

    .primary-pill-btn {
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      color: #020617;
      padding: 7px 14px;
      font-size: 11px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      box-shadow:
        0 10px 20px rgba(34, 211, 238, 0.35),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      white-space: nowrap;
    }

    .primary-pill-btn span.icon {
      font-size: 14px;
    }

    /* KPIs */
    .kpi-grid-main {
      display: grid;
      grid-template-columns: 1.25fr 1.25fr;
      gap: 10px;
      margin-bottom: 8px;
    }

    .kpi-main {
      border-radius: 18px;
      padding: 10px 10px 9px;
      background: radial-gradient(circle at top, #0ea5e9 0, #1e293b 45%, #020617 90%);
      border: 1px solid rgba(56, 189, 248, 0.9);
      box-shadow:
        0 20px 40px rgba(8, 47, 73, 0.85),
        0 0 0 1px rgba(15, 23, 42, 1);
      position: relative;
      overflow: hidden;
    }

    .kpi-main.faltante {
      background: radial-gradient(circle at top, #f97316 0, #1e293b 45%, #020617 90%);
      border-color: rgba(248, 171, 85, 0.95);
      box-shadow:
        0 20px 40px rgba(124, 45, 18, 0.85),
        0 0 0 1px rgba(15, 23, 42, 1);
    }

    .kpi-main::before {
      content: "";
      position: absolute;
      inset: -20%;
      background: radial-gradient(circle at -10% -10%, rgba(248, 250, 252, 0.18), transparent 55%);
      opacity: 0.65;
      pointer-events: none;
    }

    .kpi-label-main {
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      opacity: 0.9;
    }

    .kpi-value-main {
      font-size: 18px;
      font-weight: 700;
      margin-top: 4px;
      letter-spacing: 0.02em;
    }

    .kpi-chip-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      font-size: 10px;
      opacity: 0.9;
    }

    .kpi-chip {
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.6);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .kpi-chip-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    .kpi-grid-secondary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 4px;
    }

    .kpi-mini {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 6px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .kpi-mini-label {
      font-size: 9px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .kpi-mini-value {
      font-size: 12px;
      font-weight: 600;
    }

    .kpi-mini-tag {
      font-size: 9px;
      margin-top: 1px;
      color: var(--accent);
    }

    .kpi-footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      font-size: 10px;
      color: var(--text-soft);
    }

    /* Ventas table */
    .ventas-wrapper {
      margin-top: 6px;
      border-radius: 18px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top, #020617 0, #020617 60%);
      max-height: 230px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .ventas-header-row {
      display: grid;
      grid-template-columns: 0.8fr 1.6fr 1.1fr;
      padding: 6px 9px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-soft);
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      background: linear-gradient(to right, #0f172a, #020617);
    }

    .ventas-body {
      overflow-y: auto;
    }

    .ventas-row {
      display: grid;
      grid-template-columns: 0.8fr 1.6fr 1.1fr;
      padding: 5px 9px;
      align-items: center;
      font-size: 11px;
      border-top: 1px solid rgba(15, 23, 42, 0.9);
    }

    .ventas-row:nth-child(2n) {
      background: rgba(15, 23, 42, 0.4);
    }

    .ventas-row span.dia-label {
      color: var(--text-soft);
    }

    .ventas-row span.dia-label strong {
      color: var(--text);
      font-weight: 600;
    }

    .ventas-row input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      padding: 6px 8px;
      font-size: 11px;
      color: var(--text);
      outline: none;
      text-align: right;
    }

    .ventas-row input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.45);
    }

    .ventas-footer {
      padding: 6px 9px 7px;
      border-top: 1px solid rgba(31, 41, 55, 0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.96);
    }

    .ventas-footer strong {
      color: var(--text);
    }

    .tag-soft {
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      font-size: 10px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .tag-soft-dot {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: var(--accent);
    }

    .tab-view {
      display: none;
      flex-direction: column;
      gap: 8px;
    }

    .tab-view.active {
      display: flex;
    }

    .empty-state {
      font-size: 11px;
      color: var(--text-soft);
      padding: 6px 2px 0;
    }

    @media (max-width: 400px) {
      .app-shell {
        border-radius: 24px;
        padding-inline: 10px;
      }

      .kpi-value-main {
        font-size: 16px;
      }

      .kpi-grid-secondary {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="status-bar">
      <div>Term√≥metro de Ventas</div>
      <div id="status-date"></div>
    </div>

    <header class="header">
      <div class="app-title">
        <div class="app-icon">
          <div class="app-icon-inner">Q</div>
        </div>
        <div class="app-name-block">
          <div class="app-name">Term√≥metro de Ventas</div>
          <div class="app-subtitle">Control diario con IVA 12%</div>
        </div>
      </div>
      <div class="header-actions">
        <div class="pill">
          <span class="pill-dot"></span>
          <span id="pill-meta">Meta: Q 0.00</span>
        </div>
      </div>
    </header>

    <nav class="tab-bar">
      <button class="tab-btn active" data-tab="config">
        <span class="icon">‚öôÔ∏è</span>
        <span class="label">Configuraci√≥n</span>
      </button>
      <button class="tab-btn" data-tab="kpis">
        <span class="icon">üìä</span>
        <span class="label">Operaci√≥n</span>
      </button>
      <button class="tab-btn" data-tab="ventas">
        <span class="icon">üßæ</span>
        <span class="label">Ventas</span>
      </button>
    </nav>

    <main class="content">
      <!-- CONFIGURACI√ìN -->
      <section class="tab-view active" id="tab-config">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Par√°metros del mes</div>
              <div class="card-subtitle">Todo en Quetzales, montos con IVA incluido.</div>
            </div>
            <div class="badge">
              <span class="badge-dot"></span>
              <span>Ruta 17029</span>
            </div>
          </div>

          <div class="config-grid">
            <div class="field">
              <label for="meta-mensual">Meta mensual (Q, con IVA)</label>
              <input id="meta-mensual" type="number" min="0" step="0.01" inputmode="decimal"
                placeholder="Ej. 442232" />
            </div>
            <div class="field">
              <label for="dias-habiles">D√≠as h√°biles del mes</label>
              <input id="dias-habiles" type="number" min="1" max="31" step="1" inputmode="numeric"
                placeholder="Ej. 27" />
            </div>
            <div class="field">
              <label for="nombre-proyecto">Etiqueta / Proyecto</label>
              <input id="nombre-proyecto" type="text" maxlength="40"
                placeholder="Ej. Ruta 17029 - Noviembre" />
            </div>
            <div class="field">
              <label for="nota-config">Nota interna</label>
              <input id="nota-config" type="text" maxlength="60"
                placeholder="Ej. Considerar 2.5% rechazo" />
            </div>
          </div>

          <div class="hint">
            ‚Ä¢ Meta y ventas se manejan siempre <strong>con IVA 12%</strong>.<br />
            ‚Ä¢ Puedes cambiar meta o d√≠as h√°biles en cualquier momento, no se borran las ventas.
          </div>

          <div class="config-footer">
            <button class="ghost-btn" id="btn-reset">
              <span class="icon">‚Ü©Ô∏é</span>
              <span>Reiniciar ventas</span>
            </button>
            <button class="primary-pill-btn" id="btn-guardar-config">
              <span class="icon">‚úîÔ∏é</span>
              <span>Guardar configuraci√≥n</span>
            </button>
          </div>
        </div>
      </section>

      <!-- KPIs -->
      <section class="tab-view" id="tab-kpis">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Term√≥metro del mes</div>
              <div class="card-subtitle" id="subtitulo-proyecto">Sin nombre de proyecto</div>
            </div>
            <div class="badge">
              <span>Hoy:</span>
              <span id="badge-dia">D√≠a 0 / 0</span>
            </div>
          </div>

          <div class="kpi-grid-main">
            <div class="kpi-main" id="box-total-vendido">
              <div class="kpi-label-main">Total vendido</div>
              <div class="kpi-value-main" id="kpi-total-vendido">Q 0.00</div>
              <div class="kpi-chip-row">
                <div class="kpi-chip">
                  <span class="kpi-chip-dot"></span>
                  <span id="kpi-promedio-real-chip">Prom. real: Q 0.00</span>
                </div>
                <span style="font-size: 10px;">Con IVA</span>
              </div>
            </div>
            <div class="kpi-main faltante" id="box-faltante">
              <div class="kpi-label-main">Faltante vs meta</div>
              <div class="kpi-value-main" id="kpi-faltante">Q 0.00</div>
              <div class="kpi-chip-row">
                <div class="kpi-chip">
                  <span class="kpi-chip-dot" style="background:#fbbf24;"></span>
                  <span id="kpi-promedio-necesario-chip">Prom. necesario: Q 0.00</span>
                </div>
                <span style="font-size: 10px;">Incluye rechazo 0%</span>
              </div>
            </div>
          </div>

          <div class="kpi-grid-secondary">
            <div class="kpi-mini">
              <div class="kpi-mini-label">Avance %</div>
              <div class="kpi-mini-value" id="kpi-avance">0.0%</div>
              <div class="kpi-mini-tag" id="kpi-avance-tag">Arranque</div>
            </div>
            <div class="kpi-mini">
              <div class="kpi-mini-label">D√≠a actual</div>
              <div class="kpi-mini-value" id="kpi-dia-actual">0</div>
              <div class="kpi-mini-tag" id="kpi-dia-restante">0 d√≠as restantes</div>
            </div>
            <div class="kpi-mini">
              <div class="kpi-mini-label">Meta diaria te√≥rica</div>
              <div class="kpi-mini-value" id="kpi-meta-diaria">Q 0.00</div>
              <div class="kpi-mini-tag">Solo referencia</div>
            </div>
          </div>

          <div class="kpi-footer-row">
            <span>Promedio real considera solo d√≠as con venta registrada.</span>
            <span class="tag-soft">
              <span class="tag-soft-dot"></span>
              <span id="kpi-info-registros">0 d√≠as con venta</span>
            </span>
          </div>
        </div>
      </section>

      <!-- VENTAS -->
      <section class="tab-view" id="tab-ventas">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Venta diaria</div>
              <div class="card-subtitle">
                Ingresa las ventas por d√≠a h√°bil (con IVA).
              </div>
            </div>
            <div class="badge">
              <span id="badge-dias-habiles">0 d√≠as</span>
            </div>
          </div>

          <div id="ventas-empty" class="empty-state">
            Configura primero la <strong>meta mensual</strong> y los
            <strong>d√≠as h√°biles</strong> en la pesta√±a de Configuraci√≥n para ver
            aqu√≠ el calendario de ventas.
          </div>

          <div class="ventas-wrapper" id="ventas-wrapper" style="display:none;">
            <div class="ventas-header-row">
              <div>D√≠a</div>
              <div>Descripci√≥n</div>
              <div>Venta (Q)</div>
            </div>
            <div class="ventas-body" id="ventas-body">
              <!-- Filas generadas por JS -->
            </div>
            <div class="ventas-footer">
              <span>Total acumulado:</span>
              <span><strong id="ventas-total-footer">Q 0.00</strong></span>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const STORAGE_KEY = "termometro_ventas_v1";

    let state = {
      metaMensual: 0,
      diasHabiles: 0,
      nombreProyecto: "",
      notaConfig: "",
      ventas: [] // array de n√∫meros por d√≠a
    };

    function formatCurrency(value) {
      if (isNaN(value)) value = 0;
      const sign = value < 0 ? "-" : "";
      const abs = Math.abs(value);
      return (
        sign +
        "Q " +
        abs.toLocaleString("es-GT", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        })
      );
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        state = Object.assign(state, data);
        if (!Array.isArray(state.ventas)) state.ventas = [];
      } catch (e) {
        console.error("Error cargando estado", e);
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("Error guardando estado", e);
      }
    }

    function syncConfigUI() {
      document.getElementById("meta-mensual").value =
        state.metaMensual > 0 ? state.metaMensual : "";
      document.getElementById("dias-habiles").value =
        state.diasHabiles > 0 ? state.diasHabiles : "";
      document.getElementById("nombre-proyecto").value = state.nombreProyecto || "";
      document.getElementById("nota-config").value = state.notaConfig || "";
      document.getElementById("pill-meta").textContent =
        "Meta: " + formatCurrency(state.metaMensual);
      document.getElementById("badge-dias-habiles").textContent =
        state.diasHabiles + " d√≠as";
      document.getElementById("subtitulo-proyecto").textContent =
        state.nombreProyecto || "Sin nombre de proyecto";
    }

    function ensureVentasLength() {
      if (state.diasHabiles <= 0) {
        state.ventas = [];
        return;
      }
      const current = state.ventas.length;
      if (current < state.diasHabiles) {
        for (let i = current; i < state.diasHabiles; i++) {
          state.ventas.push(0);
        }
      } else if (current > state.diasHabiles) {
        state.ventas = state.ventas.slice(0, state.diasHabiles);
      }
    }

    function renderVentasTable() {
      const wrapper = document.getElementById("ventas-wrapper");
      const body = document.getElementById("ventas-body");
      const empty = document.getElementById("ventas-empty");

      if (!state.diasHabiles || state.diasHabiles <= 0) {
        wrapper.style.display = "none";
        empty.style.display = "block";
        body.innerHTML = "";
        document.getElementById("ventas-total-footer").textContent = formatCurrency(0);
        return;
      }

      wrapper.style.display = "flex";
      empty.style.display = "none";

      ensureVentasLength();

      body.innerHTML = "";
      state.ventas.forEach((valor, index) => {
        const dia = index + 1;
        const row = document.createElement("div");
        row.className = "ventas-row";

        const colDia = document.createElement("span");
        colDia.className = "dia-label";
        colDia.innerHTML = "D√≠a <strong>" + dia + "</strong>";

        const colDesc = document.createElement("span");
        colDesc.textContent = "Venta ruta " + dia;

        const colInput = document.createElement("input");
        colInput.type = "number";
        colInput.step = "0.01";
        colInput.min = "0";
        colInput.inputMode = "decimal";
        colInput.value = valor > 0 ? valor : "";
        colInput.addEventListener("change", (e) => {
          let v = parseFloat(e.target.value);
          if (isNaN(v) || v < 0) v = 0;
          state.ventas[index] = v;
          saveState();
          recalculateKPIs();
          updateVentasFooter();
        });

        row.appendChild(colDia);
        row.appendChild(colDesc);
        row.appendChild(colInput);
        body.appendChild(row);
      });

      updateVentasFooter();
    }

    function updateVentasFooter() {
      const total = state.ventas.reduce((sum, v) => sum + (v || 0), 0);
      document.getElementById("ventas-total-footer").textContent = formatCurrency(total);
    }

    function recalculateKPIs() {
      const meta = state.metaMensual || 0;
      const dias = state.diasHabiles || 0;
      const ventas = state.ventas || [];

      const total = ventas.reduce((sum, v) => sum + (v || 0), 0);
      const diasConVenta = ventas.filter((v) => v > 0).length;
      const diaActual = diasConVenta > 0 ? Math.max(diasConVenta, 1) : 0;

      const avance = meta > 0 ? (total / meta) * 100 : 0;
      const faltanteRaw = meta - total;
      const faltante = faltanteRaw > 0 ? faltanteRaw : 0;

      const diasRestantes =
        dias > 0
          ? Math.max(dias - (diaActual || 0), 0)
          : 0;

      const promedioReal =
        diaActual > 0 ? total / diaActual : 0;

      const promedioNecesario =
        meta > 0 && diasRestantes > 0
          ? faltante / diasRestantes
          : 0;

      const metaDiariaTeorica =
        meta > 0 && dias > 0 ? meta / dias : 0;

      document.getElementById("kpi-total-vendido").textContent =
        formatCurrency(total);
      document.getElementById("kpi-faltante").textContent =
        formatCurrency(faltante);

      document.getElementById("kpi-promedio-real-chip").textContent =
        "Prom. real: " + formatCurrency(promedioReal);
      document.getElementById("kpi-promedio-necesario-chip").textContent =
        "Prom. necesario: " + formatCurrency(promedioNecesario);

      document.getElementById("kpi-avance").textContent =
        avance.toFixed(1) + "%";

      const tag = document.getElementById("kpi-avance-tag");
      if (avance >= 100) {
        tag.textContent = "Meta superada üéâ";
      } else if (avance >= 80) {
        tag.textContent = "Muy cerca, apriete final";
      } else if (avance >= 50) {
        tag.textContent = "Mitad del camino";
      } else if (avance > 0) {
        tag.textContent = "Arranque del mes";
      } else {
        tag.textContent = "Sin ventas a√∫n";
      }

      document.getElementById("kpi-dia-actual").textContent = diaActual;
      document.getElementById("kpi-dia-restante").textContent =
        diasRestantes + " d√≠as restantes";

      document.getElementById("kpi-meta-diaria").textContent =
        formatCurrency(metaDiariaTeorica);

      document.getElementById("kpi-info-registros").textContent =
        diasConVenta + " d√≠as con venta";

      document.getElementById("badge-dia").textContent =
        "D√≠a " + diaActual + " / " + dias;

      const boxFaltante = document.getElementById("box-faltante");
      if (faltanteRaw <= 0 && meta > 0) {
        boxFaltante.style.opacity = "0.85";
      } else {
        boxFaltante.style.opacity = "1";
      }

      document.getElementById("pill-meta").textContent =
        "Meta: " + formatCurrency(meta);
      document.getElementById("badge-dias-habiles").textContent =
        dias + " d√≠as";
      document.getElementById("subtitulo-proyecto").textContent =
        state.nombreProyecto || "Sin nombre de proyecto";
    }

    function handleTabChange(tabId) {
      document
        .querySelectorAll(".tab-btn")
        .forEach((btn) => btn.classList.remove("active"));
      document
        .querySelectorAll(".tab-view")
        .forEach((view) => view.classList.remove("active"));

      document
        .querySelector('.tab-btn[data-tab="' + tabId + '"]')
        .classList.add("active");
      document.getElementById("tab-" + tabId).classList.add("active");
    }

    function setupEvents() {
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tabId = btn.getAttribute("data-tab");
          handleTabChange(tabId);
        });
      });

      document.getElementById("btn-guardar-config").addEventListener("click", () => {
        const meta = parseFloat(
          document.getElementById("meta-mensual").value
        );
        const dias = parseInt(
          document.getElementById("dias-habiles").value,
          10
        );
        const nombre = document.getElementById("nombre-proyecto").value.trim();
        const nota = document.getElementById("nota-config").value.trim();

        state.metaMensual = !isNaN(meta) && meta > 0 ? meta : 0;
        state.diasHabiles = !isNaN(dias) && dias > 0 ? dias : 0;
        state.nombreProyecto = nombre;
        state.notaConfig = nota;

        ensureVentasLength();
        saveState();
        syncConfigUI();
        renderVentasTable();
        recalculateKPIs();
        handleTabChange("kpis");
      });

      document.getElementById("btn-reset").addEventListener("click", () => {
        if (!confirm("¬øReiniciar todas las ventas del mes a 0?")) return;
        state.ventas = new Array(state.diasHabiles || 0).fill(0);
        saveState();
        renderVentasTable();
        recalculateKPIs();
      });

      ["meta-mensual", "dias-habiles", "nombre-proyecto", "nota-config"].forEach(
        (id) => {
          const el = document.getElementById(id);
          el.addEventListener("blur", () => {
            document.getElementById("btn-guardar-config").click();
          });
        }
      );
    }

    function initStatusBarDate() {
      const el = document.getElementById("status-date");
      const now = new Date();
      const formatter = new Intl.DateTimeFormat("es-GT", {
        day: "2-digit",
        month: "2-digit",
        year: "2-digit"
      });
      el.textContent = formatter.format(now);
    }

    function initApp() {
      initStatusBarDate();
      loadState();
      ensureVentasLength();
      syncConfigUI();
      renderVentasTable();
      recalculateKPIs();
      setupEvents();
    }

    document.addEventListener("DOMContentLoaded", initApp);
  </script>
</body>
</html>
