<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Nave de Cuaderno</title>

  <!-- Bloquear zoom en m√≥vil -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      overscroll-behavior-x: none;
      background:
        repeating-linear-gradient(
          to bottom,
          #fdfbf6,
          #fdfbf6 22px,
          #d7e3ff 23px
        );
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
    }

    input, button, select {
      font-size: 16px !important;
      touch-action: manipulation;
    }

    .app {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      padding: 4px 10px calc(8px + env(safe-area-inset-bottom, 0px));
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .card {
      background: rgba(255, 255, 255, 0.9);
      border: 1.5px solid #444;
      border-radius: 8px;
      padding: 6px 8px;
      box-shadow: 0 0 0 1px #00000020;
    }

    .title {
      text-align: center;
      font-family: "Comic Sans MS", system-ui;
      margin: 0 0 2px;
      font-size: 1.25rem;
    }

    .subtitle {
      text-align: center;
      font-size: 0.75rem;
      opacity: 0.7;
      margin-bottom: 4px;
    }

    label {
      font-size: 0.75rem;
      display: block;
      margin-top: 2px;
    }

    input[type="text"], select {
      width: 100%;
      padding: 5px;
      border-radius: 6px;
      border: 1px solid #888;
      margin-top: 1px;
      background: #fff;
      font-size: 0.9rem;
    }

    .row {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    button {
      background: #fff;
      padding: 7px 8px;
      border-radius: 999px;
      border: 1.5px solid #222;
      font-weight: 600;
      flex: 1;
      cursor: pointer;
      box-shadow: 1px 1px 0 #00000060;
      font-size: 0.9rem;
    }

    button:active {
      transform: translate(1px,1px);
      box-shadow: 0 0 0 #000;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      margin-top: 2px;
    }

    .game-wrapper {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    #gameCanvas {
      width: 100%;
      height: auto;
      background: #ffffff;
      border: 1.5px solid #333;
      border-radius: 12px;
      touch-action: none;
      box-shadow: 2px 2px 0 #00000040;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(3,1fr);
      gap: 6px;
      margin-top: 4px;
    }

    .ranking {
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.85rem;
      margin-top: 4px;
    }

    .ranking-item {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      border-bottom: 1px dashed #ccc;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(253, 251, 246, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }

    .overlay-card {
      width: 90%;
      max-width: 420px;
      background: #fffef8;
      border-radius: 10px;
      border: 1.5px solid #444;
      box-shadow: 2px 2px 0 #00000050;
      padding: 14px;
    }

    .overlay-card h2 {
      margin: 0 0 6px;
      font-family: "Comic Sans MS", system-ui;
      font-size: 1.2rem;
      text-align: center;
    }

    .overlay-card p {
      font-size: 0.9rem;
      margin: 4px 0;
      text-align: center;
    }

    .overlay-card .row-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .game-over-banner {
      position: absolute;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
    }

    .game-over-text {
      background: #fff8e1;
      border: 2px solid #222;
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 0.95rem;
      box-shadow: 2px 2px 0 #00000070;
      white-space: pre-line;
      text-align: center;
    }

    /* Bloquear selecci√≥n / copiar en el √°rea del juego */
    .no-select {
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
  </style>
</head>

<body>
<div class="app">

  <!-- Panel superior -->
  <div class="card no-select">
    <h1 class="title">Nave de Cuaderno</h1>
    <div class="subtitle">Dispara a los c√≠rculos. Evita que te golpeen.</div>

    <label for="playerName">Tu nombre:</label>
    <input id="playerName" type="text" placeholder="Ej. Sergio" />

    <label for="shipSkin">Nave:</label>
    <select id="shipSkin">
      <option value="1">Nave 1 - Tri√°ngulo</option>
      <option value="2">Nave 2 - Cohete</option>
      <option value="3">Nave 3 - Platillo</option>
    </select>

    <div class="row">
      <button id="btnUseName">Usar nombre</button>
      <button id="btnShowRanking">Mejor</button>
    </div>

    <div class="status-bar">
      <div><b>Jugador:</b> <span id="currentPlayer">‚Äî</span></div>
      <div><b>Mejor:</b> <span id="bestScore">0</span></div>
    </div>
  </div>

  <!-- Juego -->
  <div class="game-wrapper card no-select">
    <canvas id="gameCanvas"></canvas>

    <div class="status-bar">
      <div><b>Puntaje:</b> <span id="score">0</span></div>
      <div><b>Nivel:</b> <span id="levelLabel">1</span></div>
      <div><b>Estado:</b> <span id="gameStateText">Listo</span></div>
    </div>

    <div class="controls">
      <button id="btnLeft">‚¨ÖÔ∏è</button>
      <button id="btnShoot">üî´ / Start</button>
      <button id="btnRight">‚û°Ô∏è</button>
    </div>

    <div class="game-over-banner" id="gameOverBanner" style="display:none;">
      <div class="game-over-text" id="gameOverText">Game Over</div>
    </div>
  </div>
</div>

<!-- Pantalla de inicio tipo hoja -->
<div id="startOverlay" class="overlay">
  <div class="overlay-card">
    <h2>Nave de Cuaderno</h2>
    <p>1. Escribe tu nombre y elige una nave.</p>
    <p>2. Dispara a los c√≠rculos.</p>
    <p>3. Si un c√≠rculo toca tu nave, pierdes.</p>
    <div class="row-buttons">
      <button id="btnStartGame">Jugar</button>
    </div>
  </div>
</div>

<!-- Subpantalla de ranking -->
<div id="rankingOverlay" class="overlay" style="display:none;">
  <div class="overlay-card">
    <h2>Mejores puntajes</h2>
    <div id="rankingList" class="ranking"></div>
    <div class="row-buttons">
      <button id="btnCloseRanking">Cerrar</button>
    </div>
  </div>
</div>

<script>
/* ====================== RANKING LOCAL ====================== */
const STORAGE_KEY = "naveCuadernoRanking_v3";

function loadRanking() {
  const raw = localStorage.getItem(STORAGE_KEY);
  return raw ? JSON.parse(raw) : [];
}
function saveRanking(r) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(r));
}
function addScore(name, score) {
  const r = loadRanking();
  r.push({ name, score, date: Date.now() });
  r.sort((a, b) => b.score - a.score);
  saveRanking(r.slice(0, 20));
}
function bestFor(name) {
  const r = loadRanking().filter(x => x.name === name);
  return r.length ? Math.max(...r.map(x => x.score)) : 0;
}
function renderRanking() {
  const container = document.getElementById("rankingList");
  const r = loadRanking();
  container.innerHTML = "";
  if (!r.length) {
    container.textContent = "Sin puntajes a√∫n. Juega una partida.";
    return;
  }
  r.forEach((item, i) => {
    const row = document.createElement("div");
    row.className = "ranking-item";
    row.innerHTML = `<span>${i + 1}. ${item.name}</span><span>${item.score}</span>`;
    container.appendChild(row);
  });
}

/* ====================== SONIDOS (Web Audio) ====================== */
let audioCtx = null;
function getAudioCtx() {
  if (!audioCtx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
  }
  if (audioCtx.state === "suspended") audioCtx.resume();
  return audioCtx;
}
function beep(type) {
  try {
    const ctx = getAudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);

    if (type === "shoot") {
      osc.frequency.value = 520;
      gain.gain.setValueAtTime(0.12, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.12);
    } else if (type === "hit") {
      osc.frequency.value = 720;
      gain.gain.setValueAtTime(0.16, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
    } else if (type === "gameover") {
      osc.frequency.setValueAtTime(260, ctx.currentTime);
      osc.frequency.linearRampToValueAtTime(90, ctx.currentTime + 0.4);
      gain.gain.setValueAtTime(0.2, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.4);
    }

    osc.start();
    osc.stop(ctx.currentTime + 0.45);
  } catch (e) {
    // iOS puede bloquear audio antes de una interacci√≥n; ignorar error
  }
}

/* ====================== JUEGO ====================== */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let ship = { x: 0, y: 0, w: 42, h: 22 };
let bullets = [];
let circles = [];
let score = 0;
let running = false;
let gameOver = false;
let lastSpawnTime = 0;
let level = 1;
let currentPlayer = "";
let lastFrameTime = 0;

// movimiento continuo
let leftHeld = false;
let rightHeld = false;

// disparo autom√°tico
let shootHeld = false;
let lastShootTime = 0;
const SHOOT_INTERVAL_MS = 200;

function clampShip() {
  const half = ship.w / 2;
  if (ship.x < half) ship.x = half;
  if (ship.x > canvas.width - half) ship.x = canvas.width - half;
}

function resizeCanvas() {
  const width = canvas.clientWidth || canvas.parentElement.clientWidth || 300;
  const height = Math.min(window.innerHeight * 0.5, 440);
  canvas.width = width;
  canvas.height = height;
  ship.x = width / 2;
  ship.y = height - 40;
  clampShip();
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

function getLevel() {
  return Math.floor(score / 10) + 1;
}
function circleSpeed() {
  return 1.5 + (level - 1) * 0.4;
}
function spawnIntervalMs() {
  const base = 900;
  const min = 350;
  const interval = base - (level - 1) * 80;
  return Math.max(min, interval);
}

function spawnCircle() {
  const x = 16 + Math.random() * (canvas.width - 32);
  circles.push({
    x,
    y: -20,
    r: 10 + Math.random() * 8,
    speed: circleSpeed()
  });
}

function spawnBullet() {
  bullets.push({
    x: ship.x,
    y: ship.y - ship.h / 2,
    speed: 5
  });
  beep("shoot");
}

function resetGame() {
  bullets = [];
  circles = [];
  score = 0;
  level = 1;
  running = true;
  gameOver = false;
  leftHeld = false;
  rightHeld = false;
  shootHeld = false;
  lastSpawnTime = performance.now();
  lastFrameTime = performance.now();
  document.getElementById("score").textContent = score;
  document.getElementById("levelLabel").textContent = level;
  document.getElementById("gameStateText").textContent = "Jugando";
  document.getElementById("gameOverBanner").style.display = "none";
  requestAnimationFrame(loop);
}

function endGame() {
  if (gameOver) return;
  running = false;
  gameOver = true;
  leftHeld = false;
  rightHeld = false;
  shootHeld = false;

  document.getElementById("gameStateText").textContent = "Terminado";
  const text = `Te golpe√≥ un c√≠rculo üòµ\nPuntaje: ${score}\nNivel: ${level}`;
  document.getElementById("gameOverText").textContent = text;
  document.getElementById("gameOverBanner").style.display = "flex";
  beep("gameover");

  if (currentPlayer) {
    addScore(currentPlayer, score);
    renderRanking();
    document.getElementById("bestScore").textContent = bestFor(currentPlayer);
  }
}

function update(dt, now) {
  const newLevel = getLevel();
  if (newLevel !== level) {
    level = newLevel;
    document.getElementById("levelLabel").textContent = level;
  }

  // movimiento continuo
  const moveSpeed = 5;
  if (leftHeld) {
    ship.x -= moveSpeed * dt;
  }
  if (rightHeld) {
    ship.x += moveSpeed * dt;
  }
  clampShip();

  // disparo continuo
  if (shootHeld && running && !gameOver) {
    if (now - lastShootTime > SHOOT_INTERVAL_MS) {
      spawnBullet();
      lastShootTime = now;
    }
  }

  if (now - lastSpawnTime > spawnIntervalMs()) {
    lastSpawnTime = now;
    spawnCircle();
  }

  bullets.forEach(b => {
    b.y -= b.speed * dt;
  });
  bullets = bullets.filter(b => b.y > -10);

  circles.forEach(c => {
    c.y += circleSpeed() * dt;
  });
  circles = circles.filter(c => c.y < canvas.height + 40);

  // Colisi√≥n balas-c√≠rculos
  bullets.forEach(b => {
    circles.forEach(c => {
      if (c._hit) return;
      const dx = b.x - c.x;
      const dy = b.y - c.y;
      if (Math.sqrt(dx*dx + dy*dy) <= c.r + 4) {
        c._hit = true;
        b._hit = true;
        score++;
        document.getElementById("score").textContent = score;
        beep("hit");
      }
    });
  });
  bullets = bullets.filter(b => !b._hit);
  circles = circles.filter(c => !c._hit);

  // Colisi√≥n c√≠rculo-nave (game over)
  circles.forEach(c => {
    const dx = Math.abs(c.x - ship.x);
    const dy = Math.abs(c.y - ship.y);
    const colX = dx < ship.w * 0.6;
    const colY = dy < ship.h * 0.8;
    if (colX && colY) {
      endGame();
    }
  });
}

function drawShip() {
  const skin = document.getElementById("shipSkin").value;
  const x = ship.x;
  const y = ship.y;
  const w = ship.w;
  const h = ship.h;

  ctx.save();
  ctx.translate(x, y);
  ctx.strokeStyle = "#222";
  ctx.lineWidth = 1.6;
  ctx.lineJoin = "round";

  if (skin === "1") {
    ctx.beginPath();
    ctx.moveTo(-w / 2, h / 2);
    ctx.lineTo(0, -h / 2);
    ctx.lineTo(w / 2, h / 2);
    ctx.closePath();
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(0, 0, 3.5, 0, Math.PI * 2);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(-w / 4, h / 2);
    ctx.lineTo(-w / 6, h / 2 + 6);
    ctx.moveTo(w / 4, h / 2);
    ctx.lineTo(w / 6, h / 2 + 6);
    ctx.stroke();
  } else if (skin === "2") {
    ctx.beginPath();
    ctx.moveTo(0, -h / 2 - 4);
    ctx.lineTo(-w / 4, -h / 6);
    ctx.lineTo(-w / 4, h / 3);
    ctx.lineTo(w / 4, h / 3);
    ctx.lineTo(w / 4, -h / 6);
    ctx.closePath();
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(0, -h / 8, 3, 0, Math.PI * 2);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(-w / 4, h / 3);
    ctx.lineTo(-w / 2.5, h / 2 + 3);
    ctx.moveTo(w / 4, h / 3);
    ctx.lineTo(w / 2.5, h / 2 + 3);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(-w / 8, h / 3);
    ctx.lineTo(0, h / 2 + 6);
    ctx.lineTo(w / 8, h / 3);
    ctx.stroke();
  } else {
    ctx.beginPath();
    ctx.ellipse(0, 0, w / 2, h / 2, 0, 0, Math.PI * 2);
    ctx.stroke();

    ctx.beginPath();
    ctx.ellipse(0, -h / 4, w / 3, h / 3, 0, 0, Math.PI * 2);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(-w / 4, h / 2);
    ctx.lineTo(-w / 4, h / 2 + 6);
    ctx.moveTo(w / 4, h / 2);
    ctx.lineTo(w / 4, h / 2 + 6);
    ctx.stroke();
  }

  ctx.restore();
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.strokeStyle = "#222";
  ctx.lineWidth = 1.4;
  circles.forEach(c => {
    ctx.beginPath();
    ctx.arc(c.x, c.y, c.r, 0, Math.PI * 2);
    ctx.stroke();
  });

  bullets.forEach(b => {
    ctx.beginPath();
    ctx.moveTo(b.x, b.y);
    ctx.lineTo(b.x, b.y + 6);
    ctx.stroke();
  });

  drawShip();
}

function loop(timestamp) {
  if (!running) return;
  if (!lastFrameTime) lastFrameTime = timestamp;
  const dtMs = timestamp - lastFrameTime;
  lastFrameTime = timestamp;
  const dt = dtMs / 16.67;

  update(dt, timestamp);
  draw();
  requestAnimationFrame(loop);
}

/* ====================== CONTROLES ====================== */
const btnLeft = document.getElementById("btnLeft");
const btnRight = document.getElementById("btnRight");
const btnShoot = document.getElementById("btnShoot");

function setupHold(btn, dir) {
  btn.addEventListener("pointerdown", e => {
    e.preventDefault();
    if (!running || gameOver) return;
    if (dir === "left") leftHeld = true;
    else rightHeld = true;
  });
  btn.addEventListener("pointerup", () => {
    if (dir === "left") leftHeld = false;
    else rightHeld = false;
  });
  btn.addEventListener("pointercancel", () => {
    if (dir === "left") leftHeld = false;
    else rightHeld = false;
  });
  btn.addEventListener("pointerleave", () => {
    if (dir === "left") leftHeld = false;
    else rightHeld = false;
  });
}
setupHold(btnLeft, "left");
setupHold(btnRight, "right");

// toque r√°pido: paso corto
btnLeft.addEventListener("click", () => {
  ship.x -= 20;
  clampShip();
});
btnRight.addEventListener("click", () => {
  ship.x += 20;
  clampShip();
});

// disparo autom√°tico con hold
btnShoot.addEventListener("pointerdown", e => {
  e.preventDefault();
  if (gameOver) {
    resetGame();
  }
  if (!running) return;
  shootHeld = true;
  lastShootTime = performance.now();
  spawnBullet();
});
btnShoot.addEventListener("pointerup", () => {
  shootHeld = false;
});
btnShoot.addEventListener("pointercancel", () => {
  shootHeld = false;
});
btnShoot.addEventListener("pointerleave", () => {
  shootHeld = false;
});

let dragging = false;
canvas.addEventListener("pointerdown", e => {
  dragging = true;
  getAudioCtx(); // desbloquear audio
});
canvas.addEventListener("pointerup", () => (dragging = false));
canvas.addEventListener("pointercancel", () => (dragging = false));
canvas.addEventListener("pointermove", e => {
  if (!dragging) return;
  const rect = canvas.getBoundingClientRect();
  ship.x = e.clientX - rect.left;
  clampShip();
});

canvas.addEventListener("click", e => {
  const rect = canvas.getBoundingClientRect();
  const y = e.clientY - rect.top;
  if (y > rect.height * 0.6) {
    if (gameOver) {
      resetGame();
      return;
    }
    if (!running) return;
    spawnBullet();
  }
});

/* ====================== NOMBRE & RANKING ====================== */
const nameInput = document.getElementById("playerName");
const currentPlayerLabel = document.getElementById("currentPlayer");
const bestScoreLabel = document.getElementById("bestScore");

document.getElementById("btnUseName").addEventListener("click", () => {
  const name = nameInput.value.trim();
  if (!name) {
    alert("Escribe un nombre para guardar tus puntajes.");
    return;
  }
  currentPlayer = name;
  currentPlayerLabel.textContent = name;
  bestScoreLabel.textContent = bestFor(name);
});

const rankingOverlay = document.getElementById("rankingOverlay");
document.getElementById("btnShowRanking").addEventListener("click", () => {
  // Solo cuando no hay partida en curso
  if (running) {
    alert("Termina la partida antes de ver el ranking.");
    return;
  }
  renderRanking();
  rankingOverlay.style.display = "flex";
});
document.getElementById("btnCloseRanking").addEventListener("click", () => {
  rankingOverlay.style.display = "none";
});

/* ====================== PANTALLA DE INICIO ====================== */
const startOverlay = document.getElementById("startOverlay");
document.getElementById("btnStartGame").addEventListener("click", () => {
  startOverlay.style.display = "none";
  getAudioCtx(); // desbloquear audio con la primera acci√≥n
  resetGame();
});

// Inicial
renderRanking();
document.getElementById("levelLabel").textContent = level;
</script>
</body>
</html>
