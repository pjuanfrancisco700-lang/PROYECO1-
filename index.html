<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Nave de Cuaderno</title>

  <!-- Bloquear zoom y evitar deslizamientos -->
  <meta name="viewport" 
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    /* Evitar scroll horizontal en iPhone */
    html, body {
      overflow-x: hidden;
      overscroll-behavior-x: none;
      margin: 0;
      padding: 0;
      background:
        repeating-linear-gradient(
          to bottom,
          #fdfbf6,
          #fdfbf6 22px,
          #d7e3ff 23px
        );
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    input, button {
      font-size: 16px !important;
      touch-action: manipulation;
    }

    .app {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card {
      background: rgba(255, 255, 255, 0.85);
      border: 1.5px solid #444;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 0 0 1px #00000020;
    }

    .title {
      text-align: center;
      font-family: "Comic Sans MS";
      margin: 0 0 5px;
      font-size: 1.4rem;
    }

    .subtitle {
      text-align: center;
      font-size: 0.8rem;
      opacity: 0.7;
    }

    input[type="text"] {
      width: 100%;
      padding: 7px;
      border-radius: 6px;
      border: 1px solid #888;
      margin-top: 4px;
    }

    .row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }

    button {
      background: #fff;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1.5px solid #222;
      font-weight: 600;
      flex: 1;
      cursor: pointer;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      margin-top: 4px;
    }

    .game-wrapper {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #gameCanvas {
      width: 100%;
      height: auto;
      background: white;
      border: 1.5px solid #333;
      border-radius: 12px;
      touch-action: none;
    }

    .controls {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }

    .ranking {
      max-height: 150px;
      overflow-y: auto;
      font-size: 0.85rem;
      margin-top: 4px;
    }

    .ranking-item {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      border-bottom: 1px dashed #ccc;
    }

    .game-over-banner {
      position: absolute;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .game-over-text {
      background: #fff8e1;
      border: 2px solid #222;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 2px 2px 0 #0003;
    }
  </style>
</head>

<body>

<div class="app">

  <!-- Panel superior -->
  <div class="card">
    <h1 class="title">Nave de Cuaderno</h1>
    <div class="subtitle">Golpea c√≠rculos ‚Äî evita l√≠neas</div>

    <label>Tu nombre:</label>
    <input id="playerName" type="text" placeholder="Ej. Sergio" />

    <div class="row">
      <button id="btnUseName">Usar nombre</button>
      <button id="btnShowRanking">Ranking</button>
    </div>

    <div class="status-bar">
      <div><b>Jugador:</b> <span id="currentPlayer">‚Äî</span></div>
      <div><b>Mejor:</b> <span id="bestScore">0</span></div>
    </div>
  </div>

  <!-- Juego -->
  <div class="game-wrapper card">
    <canvas id="gameCanvas"></canvas>

    <div class="status-bar">
      <div><b>Puntaje:</b> <span id="score">0</span></div>
      <div><b>Estado:</b> <span id="gameStateText">Listo</span></div>
    </div>

    <div class="controls">
      <button id="btnLeft">‚¨ÖÔ∏è</button>
      <button id="btnShoot">üî´</button>
      <button id="btnRight">‚û°Ô∏è</button>
    </div>

    <div class="game-over-banner" id="gameOverBanner" style="display:none;">
      <div class="game-over-text" id="gameOverText">Game Over</div>
    </div>
  </div>

  <!-- Ranking -->
  <div class="card">
    <b>Ranking</b>
    <div id="rankingList" class="ranking"></div>
  </div>

</div>

<script>
/* ==========================================================
   RANKING LOCAL
========================================================== */

const STORAGE_KEY = "naveCuadernoRanking";

function loadRanking() {
  const raw = localStorage.getItem(STORAGE_KEY);
  return raw ? JSON.parse(raw) : [];
}

function saveRanking(r) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(r));
}

function addScore(name, score) {
  const r = loadRanking();
  r.push({ name, score });
  r.sort((a, b) => b.score - a.score);
  saveRanking(r.slice(0, 20));
}

function renderRanking() {
  const div = document.getElementById("rankingList");
  const r = loadRanking();
  div.innerHTML = "";
  if (!r.length) {
    div.textContent = "No hay puntajes a√∫n.";
    return;
  }
  r.forEach((item, i) => {
    const row = document.createElement("div");
    row.className = "ranking-item";
    row.innerHTML = `${i + 1}. ${item.name} <span>${item.score}</span>`;
    div.appendChild(row);
  });
}

function bestFor(name) {
  const r = loadRanking().filter(x => x.name === name);
  return r.length ? Math.max(...r.map(x => x.score)) : 0;
}

/* ==========================================================
   JUEGO
========================================================== */

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let ship = { x: 0, y: 0, w: 40, h: 20, speed: 4 };
let bullets = [];
let objects = [];
let lastSpawn = 0;
let score = 0;
let running = false;
let gameOver = false;
let currentPlayer = "";

function resizeCanvas() {
  const w = canvas.clientWidth;
  const h = Math.min(window.innerHeight * 0.45, 420);
  canvas.width = w;
  canvas.height = h;
  ship.x = w / 2;
  ship.y = h - 35;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

function spawnObject() {
  const x = 20 + Math.random() * (canvas.width - 40);
  if (Math.random() < 0.7) {
    objects.push({
      type: "circle",
      x,
      y: -20,
      r: 10 + Math.random() * 8,
      speed: 1.5
    });
  } else {
    objects.push({
      type: "line",
      x,
      y: -20,
      len: 35,
      speed: 1.3
    });
  }
}

function shoot() {
  if (!running) resetGame();
  bullets.push({ x: ship.x, y: ship.y - ship.h / 2 });
}

function resetGame() {
  bullets = [];
  objects = [];
  lastSpawn = 0;
  score = 0;
  running = true;
  gameOver = false;
  document.getElementById("score").textContent = 0;
  document.getElementById("gameStateText").textContent = "Jugando";
  document.getElementById("gameOverBanner").style.display = "none";
  requestAnimationFrame(loop);
}

function endGame() {
  running = false;
  gameOver = true;
  document.getElementById("gameStateText").textContent = "Terminado";
  document.getElementById("gameOverText").textContent =
    `Game Over\nPuntaje: ${score}`;
  document.getElementById("gameOverBanner").style.display = "flex";

  if (currentPlayer) {
    addScore(currentPlayer, score);
    renderRanking();
    document.getElementById("bestScore").textContent = bestFor(currentPlayer);
  }
}

function loop(ts) {
  if (!running) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  lastSpawn++;
  if (lastSpawn > 35) {
    spawnObject();
    lastSpawn = 0;
  }

  bullets.forEach(b => (b.y -= 5));
  bullets = bullets.filter(b => b.y > -5);

  objects.forEach(o => (o.y += o.speed));
  objects = objects.filter(o => o.y < canvas.height + 40);

  // Colisiones
  bullets.forEach(b => {
    objects.forEach(o => {
      if (o.type === "circle") {
        const dx = b.x - o.x;
        const dy = b.y - o.y;
        if (Math.sqrt(dx*dx + dy*dy) < o.r + 3) {
          o.dead = true;
          b.dead = true;
          score++;
          document.getElementById("score").textContent = score;
        }
      } else {
        if (Math.abs(b.x - o.x) < 4 && b.y >= o.y && b.y <= o.y + o.len) {
          endGame();
        }
      }
    });
  });

  bullets = bullets.filter(b => !b.dead);
  objects = objects.filter(o => !o.dead);

  // Dibujar objetos
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 1.3;

  objects.forEach(o => {
    if (o.type === "circle") {
      ctx.beginPath();
      ctx.arc(o.x, o.y, o.r, 0, Math.PI * 2);
      ctx.stroke();
    } else {
      ctx.beginPath();
      ctx.moveTo(o.x, o.y);
      ctx.lineTo(o.x, o.y + o.len);
      ctx.stroke();
    }
  });

  // Bullets
  bullets.forEach(b => {
    ctx.beginPath();
    ctx.moveTo(b.x, b.y);
    ctx.lineTo(b.x, b.y + 6);
    ctx.stroke();
  });

  // Nave
  ctx.beginPath();
  ctx.moveTo(ship.x - 20, ship.y + 10);
  ctx.lineTo(ship.x, ship.y - 10);
  ctx.lineTo(ship.x + 20, ship.y + 10);
  ctx.closePath();
  ctx.stroke();

  requestAnimationFrame(loop);
}

/* ==========================================================
   CONTROLES
========================================================== */

document.getElementById("btnLeft").onclick = () => (ship.x -= ship.speed * 3);
document.getElementById("btnRight").onclick = () => (ship.x += ship.speed * 3);
document.getElementById("btnShoot").onclick = () => shoot();

canvas.addEventListener("pointermove", e => {
  const rect = canvas.getBoundingClientRect();
  ship.x = e.clientX - rect.left;
});

/* ==========================================================
   MANEJO DE NOMBRE
========================================================== */

document.getElementById("btnUseName").onclick = () => {
  const name = document.getElementById("playerName").value.trim();
  if (!name) return alert("Escribe un nombre");
  currentPlayer = name;
  document.getElementById("currentPlayer").textContent = name;
  document.getElementById("bestScore").textContent = bestFor(name);
};

document.getElementById("btnShowRanking").onclick = renderRanking;

// Inicial
renderRanking();
</script>

</body>
</html>
